# ──────────────────────────────────────────────────────────────────────
# WareBot VPS – Nginx reverse-proxy config
# ──────────────────────────────────────────────────────────────────────
#
# This config does three things:
#   1. Serves the Flask web UI on port 80 (proxy to waitress :6700)
#   2. Proxies WebSocket on port 6701 → Pi's rosbridge through WireGuard
#      (transparent to the browser — roslib.js connects to VPS:6701 and
#       Nginx forwards it to Pi:6701 over the tunnel, zero JS changes)
#   3. Optionally terminates TLS with Let's Encrypt (certbot)
#
# Install:
#   sudo cp warebot.nginx.conf /etc/nginx/sites-available/warebot
#   sudo ln -sf /etc/nginx/sites-available/warebot /etc/nginx/sites-enabled/
#   sudo nginx -t && sudo systemctl reload nginx
#
# After certbot:
#   sudo certbot --nginx -d your-domain.com
# ──────────────────────────────────────────────────────────────────────

# ── Upstream definitions ──────────────────────────────────────────────

# Flask server running locally on VPS
upstream flask_backend {
    server 127.0.0.1:6700;
}

# rosbridge running on the Pi, reachable via WireGuard VPN
# Replace PI_WG_IP with the Pi's WireGuard IP (e.g. 10.0.0.2)
upstream rosbridge_backend {
    server PI_WG_IP:6701;
}

# ── WebSocket proxy on port 6701 ─────────────────────────────────────
# The browser's roslib.js connects to  ws://VPS_HOST:6701
# Nginx catches that and tunnels it to the Pi's rosbridge.
# This means ZERO changes to the JS client code.

server {
    listen 6701;
    server_name _;

    location / {
        proxy_pass         http://rosbridge_backend;
        proxy_http_version 1.1;

        # WebSocket upgrade headers
        proxy_set_header   Upgrade $http_upgrade;
        proxy_set_header   Connection "upgrade";

        # Preserve real client info
        proxy_set_header   Host $host;
        proxy_set_header   X-Real-IP $remote_addr;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;

        # Long timeouts for persistent WS connections
        proxy_read_timeout   86400s;
        proxy_send_timeout   86400s;
        proxy_connect_timeout 10s;
    }
}

# ── HTTP server block (Flask UI on port 80) ──────────────────────────

server {
    listen 80;
    server_name _;   # Replace with your domain if using certbot

    # ── Flask web UI ──────────────────────────────────────────────
    location / {
        proxy_pass         http://flask_backend;
        proxy_http_version 1.1;
        proxy_set_header   Host $host;
        proxy_set_header   X-Real-IP $remote_addr;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;

        # SSE / long-poll support
        proxy_buffering off;
    }

    # ── Static assets caching ─────────────────────────────────────
    location ~* \.(js|css|png|jpg|jpeg|svg|ico|woff2?|ttf|json)$ {
        proxy_pass         http://flask_backend;
        proxy_cache_valid  200 1h;
        expires            1h;
        add_header         Cache-Control "public, immutable";
    }
}

<div id="icon_bar">
	<div id="icon_bar_toggle" class="icon" title="Toggle widgets" aria-label="Toggle widgets">â‰¡</div>

	<div id="icon_container" onmousedown="iconContainerScrollHandler(event)">
		<!-- Icon templates get rendered in here  -->
	</div>

	<div id="hidden_icon_container" aria-hidden="true"></div>

</div>

<script>

	//drag scrolling with a mouse
	function iconContainerScrollHandler(event) {
		event.preventDefault();

		const container = document.getElementById('icon_container');
		container.setAttribute("mouse_start", event.clientY)
		container.setAttribute("scroll_start", document.getElementById('icon_bar').scrollTop)

		document.addEventListener('mousemove', iconContainerMouseMove);
		document.addEventListener('mouseup', iconContainerMouseUp);
	}

	function iconContainerMouseMove(event) {
		const container = document.getElementById('icon_container');
		const scroll_start = parseFloat(container.getAttribute("scroll_start"));
		const mouse_start = parseFloat(container.getAttribute("mouse_start"));
		document.getElementById('icon_bar').scrollTop = scroll_start + (mouse_start - event.clientY);
	}

	function iconContainerMouseUp() {
		document.removeEventListener('mousemove', iconContainerMouseMove);
		document.removeEventListener('mouseup', iconContainerMouseUp);
	}

	function calculateHeight() {
		const iconBar = document.getElementById('icon_bar');
		const iconContainer = document.getElementById('icon_container');

		if(iconBar.style.width == ""){
			iconBar.style.width = "75px";
		}

		const barWidth = parseInt(iconBar.style.width);
		const numColumns = Math.max(1, Math.floor((barWidth - 10) / 60));
		const totalIcons = iconContainer.children.length;
		let requiredHeight = Math.ceil(totalIcons / numColumns) * 60 + 10;

		if (requiredHeight < window.innerHeight)
			requiredHeight = window.innerHeight;

		iconContainer.style.height = requiredHeight + 'px';

		window.dispatchEvent(new Event("iconbar_height_change"));
	}

	window.addEventListener('icons_changed', calculateHeight);
	window.addEventListener('resize', calculateHeight);

	//allow scrolling without holding down shift
	document.getElementById('icon_bar').addEventListener("wheel", function (e) {
		document.getElementById('icon_bar').scrollTop += e.deltaY*0.5;
	});

	function toggleCollapsed() {
		const iconBar = document.getElementById('icon_bar');
		if (iconBar.classList.contains('collapsed')) {
			iconBar.classList.remove('collapsed');
			localStorage.setItem('iconBarCollapsed', 'false');
		} else {
			iconBar.classList.add('collapsed');
			localStorage.setItem('iconBarCollapsed', 'true');
		}
		calculateHeight();
	}

	//restore collapsed on load, this is display-specific so it's not part of the main settings
	document.addEventListener('DOMContentLoaded', ()=>{
		const iconBar = document.getElementById('icon_bar');
		const savedCollapsed = localStorage.getItem('iconBarCollapsed');

		if (savedCollapsed === 'true') {
			iconBar.classList.add('collapsed');
		}
		calculateHeight();
	});

	document.getElementById('icon_bar_toggle').addEventListener('click', (event) => {
		event.preventDefault();
		event.stopPropagation();
		toggleCollapsed();
	});

</script>
